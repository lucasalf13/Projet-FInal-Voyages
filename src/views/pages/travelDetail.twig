{% extends "../layouts/base.twig" %}

{% block style %}
	<link rel="stylesheet" href="/assets/css/style.css"/>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@glidejs/glide/dist/css/glide.core.min.css">
{% endblock %}

{% block title %}
	<title>{{ voyage.name }}
		| √âchapp√©eVerte</title>
{% endblock %}

{% block main %}
	<main class="voyage-detail-main page-detail">
		<h1 class="voyage-title-flex">
		    <span class="left-spacer"></span
    <span class="title-text">{{ voyage.name }}</span>
			{% if user %}
				<button class="fav-btn{{ voyage.isFavori ? ' is-favori' : '' }}" data-voyage-id="{{ voyage.id }}" aria-label="{{ t('add_remove_favorite') }}" data-add-label="{{ t('add_favorite') }}" data-remove-label="{{ t('remove_favorite') }}">
					<span class="fav-label">{{ voyage.isFavori ? t('remove_favorite') : t('add_favorite') }}</span>
					<span aria-hidden="true">{{ voyage.isFavori ? '‚ù§Ô∏è&nbsp;' : 'ü§ç&nbsp;' }}</span>
				</button>
			{% endif %}
		</h1>

		{% if photos %}
			{% set photoCaptions = voyage.photoCaptions ? voyage.photoCaptions|split(';') : [] %}
			<div class="voyage-photo-carousel glide">
				<div class="glide__track" data-glide-el="track">
					<ul class="glide__slides">
						{% for photo in photos %}
							<li class="glide__slide">
								<img src="/assets/img/{{ photo }}" alt="{{ photoCaptions[loop.index0]|default('') }}" class="carousel-img-zoom" style="cursor:pointer;" onclick="showZoom(this.src, '{{ photoCaptions[loop.index0]|default('')|e('js') }}')"/>
								<div class="carousel-caption">
									{{ photoCaptions[loop.index0]|default('Photo du voyage') }}
								</div>
							</li>
						{% endfor %}
					</ul>
				</div>
			</div>
		{% endif %}


		<div id="itineraire-zoom-overlay" onclick="hideOverlay()">
			<img id="itineraire-zoom-img" src="" alt="Zoom image"/>
			<div id="itineraire-zoom-caption" class="zoom-caption"></div>
		</div>

		<div class="voyage-grid">

			<h3 class="section-titre">{{ t('itinerary') }}</h3>
			<div class="cards-row">
				{% for itin in voyage.itineraries|slice(0,3) %}
					<div class="card-detail card-itinerary">
						<button class="btn-itin-toggle" type="button" onclick="toggleDetails('itin-detail-{{ itin.id }}')">
							{{ itin.title }}
						</button>
						<div class="itin-detail" id="itin-detail-{{ itin.id }}" style="display:none;">
							<div class="itin-detail-content">{{ itin.detail|raw }}</div>
						</div>
					</div>
				{% endfor %}
			</div>

			<div class="sections-flex">
				<div class="section-col">
					<h3 class="section-titre">{{ t('ou_manger') }}</h3>
					<div class="cards-row">
						{% if voyage.restaurants %}
							{% for resto in voyage.restaurants|slice(0,3) %}
								<div class="card-detail">
								{% if resto.url %}
                <a href="{{ resto.url }}" target="_blank" rel="noopener noreferrer" style="text-decoration: none; color: inherit;">
            {% endif %}
									<img src="/assets/img/{{ resto.photo }}" alt="{{ resto.title }}">
									<div class="card-nom">{{ resto.title }}</div>
									<div class="card-euro">
										{{ resto.priceCategory == 'EURO' ? '‚Ç¨' : resto.priceCategory == 'TWO_EURO' ? '‚Ç¨‚Ç¨' : '‚Ç¨‚Ç¨‚Ç¨' }}
									</div>
									 {% if resto.url %}
                </a>
            {% endif %}
								</div>
							{% endfor %}
						{% endif %}
					</div>
				</div>

				<div class="section-col">
					<h3 class="section-titre">{{ t('ou_dormir') }}</h3>
					<div class="cards-row">
						{% if voyage.accommodations %}
							{% for acc in voyage.accommodations|slice(0,3) %}
								<div class="card-detail">
								{% if acc.url %}
						<a href="{{ acc.url }}" target="_blank" rel="noopener noreferrer" style="text-decoration: none; color: inherit;">
					{% endif %}
									<img src="/assets/img/{{ acc.photo }}" alt="{{ acc.title }}">
									<div class="card-nom">{{ acc.title }}</div>
									<div class="card-euro">
										{{ acc.priceCategory == 'EURO' ? '‚Ç¨' : acc.priceCategory == 'TWO_EURO' ? '‚Ç¨‚Ç¨' : '‚Ç¨‚Ç¨‚Ç¨' }}
									</div>
									{% if acc.url %}
						</a>
					{% endif %}
								</div>
							{% endfor %}
						{% endif %}
					</div>
				</div>
			</div>

			<h3 class="section-titre">{{ t('transports') }}</h3>
			<div class="cards-row">
				{% for transport in voyage.transports %}
					<div class="card-detail card-transport">
						<div class="card-nom">{{ transport.type|capitalize }}</div>
						<div class="card-detail-content">{{ transport.detail }}</div>
					</div>
				{% endfor %}
			</div>
		</div>

		<div class="download-pdf">
			<a href="/voyages/{{ voyage.id }}/pdf" class="btn-download">{{ t('download_pdf') }}</a>
		</div>

		{% if user and user.role == 'admin' %}
			<div class="admin-actions" style="text-align:center; margin-top:24px;">
				<form action="/voyages/{{ voyage.id }}/delete" method="POST" style="display:inline;">
					<button type="submit" class="btn-delete">{{ t('delete') }}</button>
				</form>
				<a href="/voyages/{{ voyage.id }}/edit" class="btn-edit">{{ t('edit') }}</a>
			</div>
		{% endif %}
	</main>

	<script src="https://cdn.jsdelivr.net/npm/@glidejs/glide/dist/glide.min.js"></script>
	<script>
		// Toggle d'affichage de l'itin√©raire
function toggleDetails(id) {
const el = document.getElementById(id);
if (! el) 
return;

el.style.display = (el.style.display === 'none' || el.style.display === '') ? 'block' : 'none';
}

// Zoom photo
function showZoom(src, caption) {
const overlay = document.getElementById('itineraire-zoom-overlay');
const imgZoom = document.getElementById('itineraire-zoom-img');
const captionDiv = document.getElementById('itineraire-zoom-caption');
imgZoom.src = src;
captionDiv.textContent = caption || '';
overlay.classList.add('active');
}

function hideOverlay() {
const overlay = document.getElementById('itineraire-zoom-overlay');
overlay.classList.remove('active');
document.getElementById('itineraire-zoom-img').src = '';
document.getElementById('itineraire-zoom-caption').textContent = '';
}

// GlideJS carousel
document.addEventListener('DOMContentLoaded', function () {
const glideElement = document.querySelector('.glide');
if (glideElement) {
const glide = new Glide(glideElement, {
type: 'carousel',
perView: 5,
autoplay: 2000,
gap: 18,
hoverpause: true,
animationDuration: 800,
breakpoints: {
900: {
perView: 4
},
600: {
perView: 2
}
}
});
glide.mount();
glideElement.classList.add('glide--loaded');
}
});

document.addEventListener('DOMContentLoaded', () => {
document.querySelectorAll('.fav-btn').forEach(btn => {
btn.addEventListener('click', async (e) => {
e.preventDefault();

const voyageId = btn.dataset.voyageId;
if (! voyageId) 
return;


try {
const response = await fetch (`/favoris/${voyageId}`, {
method: 'POST',
headers: {
'Content-Type': 'application/json'
}
});

if (! response.ok) 
throw new Error (`HTTP error! status: ${
response.status
}`);


const data = await response.json();

if (data.isFavori) {
btn.classList.add('is-favori');
btn.setAttribute('aria-label', btn.dataset.removeLabel);
btn.innerHTML = `<span class="fav-label">${btn.dataset.removeLabel}</span><span class="fav-icon" aria-hidden="true">&nbsp;‚ù§Ô∏è</span>`;

} else {
btn.classList.remove('is-favori');
btn.setAttribute('aria-label', btn.dataset.addLabel);
btn.innerHTML = `<span class="fav-label">${btn.dataset.addLabel}</span><span class="fav-icon" aria-hidden="true">&nbsp;ü§ç</span>`;

}
} catch (error) {
console.error('Erreur lors de la mise √† jour des favoris:', error);
alert('Une erreur est survenue. Merci de r√©essayer.');
}
});
});
});
	</script>
{% endblock %}
